<!DOCTYPE html>
<html lang="fr" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Responsables - Tily</title>
    <link rel="stylesheet" th:href="@{/css/dashboard.css}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <!-- Sidebar -->
    <div th:replace="~{fragments/sidebar :: sidebar('responsables')}"></div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Topbar -->
        <div th:replace="~{fragments/topbar :: topbar(${pageTitle}, ${userName})}"></div>

        <!-- Page Content -->
        <div class="dashboard-content">
            <!-- Messages de notification -->
            <div th:if="${successMessage}" class="alert alert-success">
                <i class="fas fa-check-circle"></i>
                <span th:text="${successMessage}"></span>
                <button class="alert-close" onclick="this.parentElement.remove()">&times;</button>
            </div>
            <div th:if="${errorMessage}" class="alert alert-error">
                <i class="fas fa-exclamation-circle"></i>
                <span th:text="${errorMessage}"></span>
                <button class="alert-close" onclick="this.parentElement.remove()">&times;</button>
            </div>

            <!-- Header avec actions -->
            <div class="page-header">
                <div class="header-left">
                    <h2>Liste des Responsables</h2>
                    <span class="record-count" id="recordCount" th:text="${totalCount} + ' responsable' + (${totalCount} > 1 ? 's' : '')">0 responsable</span>
                </div>
                <div class="header-actions">
                    <button class="btn-primary" onclick="openAddModal()">
                        <i class="fas fa-plus"></i>
                        Ajouter
                    </button>
                </div>
            </div>

            <!-- Filtres -->
            <div class="filters-section">
                <div class="filters-row">
                    <div class="filter-group">
                        <label>Recherche</label>
                        <div class="search-filter">
                            <i class="fas fa-search"></i>
                            <input type="text" id="searchInput" placeholder="Nom, prénom, totem..." onkeyup="applyFilters()">
                        </div>
                    </div>
                    <div class="filter-group">
                        <label>Secteur</label>
                        <select id="filterSecteur" onchange="applyFilters()">
                            <option value="">Tous les secteurs</option>
                            <option th:each="secteur : ${secteurs}" th:value="${secteur.nom}" th:text="${secteur.nom}"></option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Section</label>
                        <select id="filterSection" onchange="applyFilters()">
                            <option value="">Toutes les sections</option>
                            <option th:each="section : ${sections}" th:value="${section.nom}" th:text="${section.nom}"></option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Niveau</label>
                        <select id="filterNiveau" onchange="applyFilters()">
                            <option value="">Tous les niveaux</option>
                            <option value="Louveteau">Louveteau</option>
                            <option value="Éclaireur">Éclaireur</option>
                            <option value="Routier">Routier</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Assurance</label>
                        <select id="filterAssurance" onchange="applyFilters()">
                            <option value="">Toutes</option>
                            <option value="Oui">Oui</option>
                            <option value="Non">Non</option>
                        </select>
                    </div>
                </div>
                <div class="filters-actions">
                    <button class="btn-secondary" onclick="resetFilters()">
                        <i class="fas fa-undo"></i>
                        Réinitialiser
                    </button>
                    <button class="btn-pdf" onclick="exportToPDF()">
                        <i class="fas fa-file-pdf"></i>
                        Exporter PDF
                    </button>
                </div>
            </div>

            <!-- Tableau des Responsables -->
            <div class="table-card">
                <div class="table-container">
                    <table class="data-table" id="responsablesTable">
                        <thead>
                            <tr>
                                <th class="sortable" onclick="sortTable(0)">Photo</th>
                                <th class="sortable" onclick="sortTable(1)">Nom <i class="fas fa-sort"></i></th>
                                <th class="sortable" onclick="sortTable(2)">Prénom <i class="fas fa-sort"></i></th>
                                <th class="sortable" onclick="sortTable(3)">Totem <i class="fas fa-sort"></i></th>
                                <th class="sortable" onclick="sortTable(4)">Date Naissance <i class="fas fa-sort"></i></th>
                                <th class="sortable" onclick="sortTable(5)">N° CIN <i class="fas fa-sort"></i></th>
                                <th class="sortable" onclick="sortTable(6)">Téléphone <i class="fas fa-sort"></i></th>
                                <th class="sortable" onclick="sortTable(7)">Secteur <i class="fas fa-sort"></i></th>
                                <th class="sortable" onclick="sortTable(8)">Section <i class="fas fa-sort"></i></th>
                                <th class="sortable" onclick="sortTable(9)">Niveau <i class="fas fa-sort"></i></th>
                                <th class="sortable" onclick="sortTable(10)">Fanekena <i class="fas fa-sort"></i></th>
                                <th class="sortable" onclick="sortTable(11)">Assurance <i class="fas fa-sort"></i></th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Message si aucune donnée -->
                            <tr th:if="${#lists.isEmpty(responsables)}">
                                <td colspan="13" class="empty-message">
                                    <i class="fas fa-inbox"></i>
                                    <p>Aucun responsable trouvé</p>
                                </td>
                            </tr>
                            <!-- Données dynamiques -->
                            <tr th:each="resp : ${responsables}" 
                                th:data-secteur="${resp.secteur != null ? resp.secteur.nom : ''}"
                                th:data-section="${resp.section != null ? resp.section.nom : ''}"
                                th:data-niveau="${resp.niveau}"
                                th:data-assurance="${resp.assurance != null && resp.assurance.statut == 'Active' ? 'Oui' : 'Non'}">
                                <td>
                                    <img th:if="${resp.image != null and !resp.image.isEmpty()}" th:src="${resp.image}" class="avatar" alt="Photo">
                                    <img th:unless="${resp.image != null and !resp.image.isEmpty()}" 
                                         th:src="'https://ui-avatars.com/api/?name=' + ${resp.prenom} + '+' + ${resp.nom} + '&background=667eea&color=fff'" 
                                         class="avatar" alt="Photo">
                                </td>
                                <td th:text="${resp.nom}">-</td>
                                <td th:text="${resp.prenom}">-</td>
                                <td th:text="${resp.totem}">-</td>
                                <td th:text="${resp.dateNaissance != null ? #temporals.format(resp.dateNaissance, 'dd/MM/yyyy') : '-'}">-</td>
                                <td th:text="${resp.numeroCin}">-</td>
                                <td th:text="${resp.numeroTelephone}">-</td>
                                <td th:text="${resp.secteur != null ? resp.secteur.nom : '-'}">-</td>
                                <td th:text="${resp.section != null ? resp.section.nom : '-'}">-</td>
                                <td>
                                    <span th:if="${resp.niveau == 'Louveteau'}" class="badge-niveau louveteau">Louveteau</span>
                                    <span th:if="${resp.niveau == 'Éclaireur'}" class="badge-niveau eclaireur">Éclaireur</span>
                                    <span th:if="${resp.niveau == 'Routier'}" class="badge-niveau routier">Routier</span>
                                    <span th:if="${resp.niveau == null}">-</span>
                                </td>
                                <td th:text="${resp.dateFanekena != null ? #temporals.format(resp.dateFanekena, 'dd/MM/yyyy') : '-'}">-</td>
                                <td>
                                    <span th:if="${resp.assurance != null && resp.assurance.statut == 'Active'}" class="status-badge delivered">Oui</span>
                                    <span th:unless="${resp.assurance != null && resp.assurance.statut == 'Active'}" class="status-badge pending">Non</span>
                                </td>
                                <td class="actions-cell">
                                    <button class="btn-icon" title="Voir" th:onclick="'viewPerson(' + ${resp.id} + ')'"><i class="fas fa-eye"></i></button>
                                    <button class="btn-icon" title="Modifier" th:onclick="'editPerson(' + ${resp.id} + ')'"><i class="fas fa-edit"></i></button>
                                    <form th:action="@{/responsables/supprimer}" method="post" style="display: inline;">
                                        <input type="hidden" name="id" th:value="${resp.id}">
                                        <button type="submit" class="btn-icon danger" title="Supprimer" onclick="return confirm('Êtes-vous sûr de vouloir supprimer ce responsable ?')"><i class="fas fa-trash"></i></button>
                                    </form>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- Pagination -->
                <div class="table-footer">
                    <div class="rows-per-page">
                        <span>Lignes par page:</span>
                        <select>
                            <option>10</option>
                            <option>25</option>
                            <option>50</option>
                        </select>
                    </div>
                    <div class="pagination">
                        <span id="paginationInfo" th:text="'1-' + ${totalCount} + ' sur ' + ${totalCount}">1-0 sur 0</span>
                        <button class="btn-icon" disabled><i class="fas fa-chevron-left"></i></button>
                        <button class="btn-icon"><i class="fas fa-chevron-right"></i></button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div th:replace="~{fragments/footer :: footer}"></div>
    </div>

    <!-- Modal Ajouter Responsable -->
    <div id="addModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-user-plus"></i> Ajouter un Responsable</h2>
                <button class="modal-close" onclick="closeAddModal()">&times;</button>
            </div>
            <form th:action="@{/responsables/ajouter}" method="post">
                <div class="modal-body">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="nom">Nom <span class="required">*</span></label>
                            <input type="text" id="nom" name="nom" required placeholder="Ex: RAKOTO">
                        </div>
                        <div class="form-group">
                            <label for="prenom">Prénom <span class="required">*</span></label>
                            <input type="text" id="prenom" name="prenom" required placeholder="Ex: Jean">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="totem">Totem</label>
                            <input type="text" id="totem" name="totem" placeholder="Ex: Akanga">
                        </div>
                        <div class="form-group">
                            <label for="dateNaissance">Date de Naissance</label>
                            <input type="date" id="dateNaissance" name="dateNaissance">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="numeroCin">Numéro CIN</label>
                            <input type="text" id="numeroCin" name="numeroCin" placeholder="Ex: 101 251 456 789">
                        </div>
                        <div class="form-group">
                            <label for="numeroTelephone">Téléphone</label>
                            <input type="text" id="numeroTelephone" name="numeroTelephone" placeholder="Ex: 034 12 345 67">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="nomPere">Nom du Père</label>
                            <input type="text" id="nomPere" name="nomPere" placeholder="Ex: Pierre Rakoto">
                        </div>
                        <div class="form-group">
                            <label for="nomMere">Nom de la Mère</label>
                            <input type="text" id="nomMere" name="nomMere" placeholder="Ex: Marie Rasoa">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="secteurId">Secteur</label>
                            <select id="secteurId" name="secteurId">
                                <option value="">-- Sélectionner --</option>
                                <option th:each="secteur : ${secteurs}" th:value="${secteur.id}" th:text="${secteur.nom}"></option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="sectionId">Section</label>
                            <select id="sectionId" name="sectionId">
                                <option value="">-- Sélectionner --</option>
                                <option th:each="section : ${sections}" th:value="${section.id}" th:text="${section.nom}"></option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="niveau">Niveau</label>
                            <select id="niveau" name="niveau">
                                <option value="">-- Sélectionner --</option>
                                <option value="Louveteau">Louveteau</option>
                                <option value="Éclaireur">Éclaireur</option>
                                <option value="Routier">Routier</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="dateFanekena">Date Fanekena</label>
                            <input type="date" id="dateFanekena" name="dateFanekena">
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-secondary" onclick="closeAddModal()">
                        <i class="fas fa-times"></i> Annuler
                    </button>
                    <button type="submit" class="btn-primary">
                        <i class="fas fa-save"></i> Enregistrer
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Toggle sidebar mobile
        function toggleSidebar() {
            const sidebar = document.querySelector('.sidebar');
            sidebar.classList.toggle('active');
        }

        // Toggle sidebar collapse/expand
        function toggleSidebarCollapse() {
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.querySelector('.main-content');
            const toggleIcon = sidebar.querySelector('.sidebar-toggle i');
            
            sidebar.classList.toggle('collapsed');
            mainContent.classList.toggle('sidebar-collapsed');
            
            if (sidebar.classList.contains('collapsed')) {
                toggleIcon.classList.remove('fa-chevron-left');
                toggleIcon.classList.add('fa-chevron-right');
                localStorage.setItem('sidebarCollapsed', 'true');
            } else {
                toggleIcon.classList.remove('fa-chevron-right');
                toggleIcon.classList.add('fa-chevron-left');
                localStorage.setItem('sidebarCollapsed', 'false');
            }
        }
        
        // Restore sidebar state
        document.addEventListener('DOMContentLoaded', function() {
            const isCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';
            if (isCollapsed) {
                const sidebar = document.getElementById('sidebar');
                const mainContent = document.querySelector('.main-content');
                const toggleIcon = sidebar.querySelector('.sidebar-toggle i');
                
                sidebar.classList.add('collapsed');
                mainContent.classList.add('sidebar-collapsed');
                toggleIcon.classList.remove('fa-chevron-left');
                toggleIcon.classList.add('fa-chevron-right');
            }
            
            // Auto-hide alerts after 5 seconds
            setTimeout(() => {
                document.querySelectorAll('.alert').forEach(alert => {
                    alert.style.opacity = '0';
                    setTimeout(() => alert.remove(), 300);
                });
            }, 5000);
        });

        // Tri du tableau
        let sortDirection = {};
        
        function sortTable(columnIndex) {
            const table = document.getElementById('responsablesTable');
            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.querySelectorAll('tr:not(.empty-message)'));
            
            sortDirection[columnIndex] = !sortDirection[columnIndex];
            const direction = sortDirection[columnIndex] ? 1 : -1;
            
            rows.sort((a, b) => {
                const aValue = a.cells[columnIndex].textContent.trim();
                const bValue = b.cells[columnIndex].textContent.trim();
                
                if (aValue.match(/^\d{2}\/\d{2}\/\d{4}$/)) {
                    const aDate = aValue.split('/').reverse().join('-');
                    const bDate = bValue.split('/').reverse().join('-');
                    return direction * (new Date(aDate) - new Date(bDate));
                }
                
                return direction * aValue.localeCompare(bValue, 'fr');
            });
            
            document.querySelectorAll('.sortable i').forEach(icon => {
                icon.className = 'fas fa-sort';
            });
            const header = table.querySelectorAll('th')[columnIndex];
            const icon = header.querySelector('i');
            if (icon) {
                icon.className = sortDirection[columnIndex] ? 'fas fa-sort-up' : 'fas fa-sort-down';
            }
            
            rows.forEach(row => tbody.appendChild(row));
        }

        // Appliquer tous les filtres
        function applyFilters() {
            const searchValue = document.getElementById('searchInput').value.toLowerCase();
            const secteurValue = document.getElementById('filterSecteur').value;
            const sectionValue = document.getElementById('filterSection').value;
            const niveauValue = document.getElementById('filterNiveau').value;
            const assuranceValue = document.getElementById('filterAssurance').value;
            
            const table = document.getElementById('responsablesTable');
            const rows = table.querySelectorAll('tbody tr:not(.empty-message)');
            let visibleCount = 0;
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                const secteur = row.getAttribute('data-secteur') || '';
                const section = row.getAttribute('data-section') || '';
                const niveau = row.getAttribute('data-niveau') || '';
                const assurance = row.getAttribute('data-assurance') || '';
                
                const matchSearch = !searchValue || text.includes(searchValue);
                const matchSecteur = !secteurValue || secteur === secteurValue;
                const matchSection = !sectionValue || section === sectionValue;
                const matchNiveau = !niveauValue || niveau === niveauValue;
                const matchAssurance = !assuranceValue || assurance === assuranceValue;
                
                if (matchSearch && matchSecteur && matchSection && matchNiveau && matchAssurance) {
                    row.style.display = '';
                    visibleCount++;
                } else {
                    row.style.display = 'none';
                }
            });
            
            document.getElementById('recordCount').textContent = visibleCount + ' responsable' + (visibleCount > 1 ? 's' : '');
            document.getElementById('paginationInfo').textContent = '1-' + visibleCount + ' sur ' + visibleCount;
        }

        // Réinitialiser les filtres
        function resetFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('filterSecteur').value = '';
            document.getElementById('filterSection').value = '';
            document.getElementById('filterNiveau').value = '';
            document.getElementById('filterAssurance').value = '';
            applyFilters();
        }

        // Modal functions
        function openAddModal() {
            document.getElementById('addModal').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeAddModal() {
            document.getElementById('addModal').classList.remove('active');
            document.body.style.overflow = '';
        }

        // Close modal on outside click
        document.getElementById('addModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeAddModal();
            }
        });

        // Close modal on Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeAddModal();
            }
        });

        // Export PDF
        function exportToPDF() {
            const table = document.getElementById('responsablesTable');
            const rows = table.querySelectorAll('tbody tr:not(.empty-message)');
            const visibleRows = Array.from(rows).filter(row => row.style.display !== 'none');
            
            if (visibleRows.length === 0) {
                alert('Aucune donnée à exporter');
                return;
            }

            // Get active filters for title
            const secteur = document.getElementById('filterSecteur').value;
            const section = document.getElementById('filterSection').value;
            const niveau = document.getElementById('filterNiveau').value;
            const assurance = document.getElementById('filterAssurance').value;
            
            let filterTitle = 'Liste des Responsables';
            let filters = [];
            if (secteur) filters.push('Secteur: ' + secteur);
            if (section) filters.push('Section: ' + section);
            if (niveau) filters.push('Niveau: ' + niveau);
            if (assurance) filters.push('Assurance: ' + assurance);
            
            // Create printable content
            let printContent = `
                <html>
                <head>
                    <title>Export Responsables - Tily</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 20px; }
                        h1 { color: #0B1739; font-size: 24px; margin-bottom: 5px; }
                        .filters { color: #666; font-size: 12px; margin-bottom: 20px; }
                        .date { color: #666; font-size: 11px; margin-bottom: 20px; }
                        table { width: 100%; border-collapse: collapse; font-size: 11px; }
                        th { background: #0B1739; color: white; padding: 10px 8px; text-align: left; }
                        td { padding: 8px; border-bottom: 1px solid #ddd; }
                        tr:nth-child(even) { background: #f9f9f9; }
                        .footer { margin-top: 30px; text-align: center; color: #666; font-size: 10px; }
                    </style>
                </head>
                <body>
                    <h1>${filterTitle}</h1>
                    ${filters.length > 0 ? '<p class="filters">Filtres: ' + filters.join(' | ') + '</p>' : ''}
                    <p class="date">Exporté le: ${new Date().toLocaleDateString('fr-FR')} à ${new Date().toLocaleTimeString('fr-FR')}</p>
                    <table>
                        <thead>
                            <tr>
                                <th>Nom</th>
                                <th>Prénom</th>
                                <th>Totem</th>
                                <th>Date Naissance</th>
                                <th>Téléphone</th>
                                <th>Secteur</th>
                                <th>Section</th>
                                <th>Niveau</th>
                                <th>Assurance</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            visibleRows.forEach(row => {
                const cells = row.querySelectorAll('td');
                printContent += `
                    <tr>
                        <td>${cells[1].textContent}</td>
                        <td>${cells[2].textContent}</td>
                        <td>${cells[3].textContent}</td>
                        <td>${cells[4].textContent}</td>
                        <td>${cells[6].textContent}</td>
                        <td>${cells[7].textContent}</td>
                        <td>${cells[8].textContent}</td>
                        <td>${cells[9].textContent}</td>
                        <td>${cells[11].textContent}</td>
                    </tr>
                `;
            });
            
            printContent += `
                        </tbody>
                    </table>
                    <div class="footer">
                        <p>Total: ${visibleRows.length} responsable(s) - Tily © ${new Date().getFullYear()}</p>
                    </div>
                </body>
                </html>
            `;
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(printContent);
            printWindow.document.close();
            printWindow.focus();
            setTimeout(() => {
                printWindow.print();
            }, 250);
        }

        function viewPerson(id) {
            alert('Voir détails du responsable ID: ' + id);
        }

        function editPerson(id) {
            alert('Modifier responsable ID: ' + id);
        }
    </script>
</body>
</html>
