<!DOCTYPE html>
<html lang="mg" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mpiandraikitra - Tily</title>
    <link rel="stylesheet" th:href="@{/css/dashboard.css}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <!-- Sidebar -->
    <div th:replace="~{fragments/sidebar :: sidebar('responsables')}"></div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Topbar -->
        <div th:replace="~{fragments/topbar :: topbar(${pageTitle}, ${userName})}"></div>

        <!-- Page Content -->
        <div class="dashboard-content">
            <!-- Messages de notification -->
            <div th:if="${successMessage}" class="alert alert-success">
                <i class="fas fa-check-circle"></i>
                <span th:text="${successMessage}"></span>
                <button class="alert-close" onclick="this.parentElement.remove()">&times;</button>
            </div>
            <div th:if="${errorMessage}" class="alert alert-error">
                <i class="fas fa-exclamation-circle"></i>
                <span th:text="${errorMessage}"></span>
                <button class="alert-close" onclick="this.parentElement.remove()">&times;</button>
            </div>

            <!-- Header avec actions -->
            <div class="page-header">
                <div class="header-left">
                    <h2>Lisitry ny Mpiandraikitra</h2>
                    <span class="record-count" id="recordCount" th:text="${totalCount} + ' Mpiandraikitra'">0 Mpiandraikitra</span>
                </div>
                <div class="header-actions">
                    <label for="excelFileMpiandraikitra" class="btn-secondary" style="cursor: pointer; margin-right: 10px;">
                        <i class="fas fa-file-excel"></i>
                        Ampidirina avy amin'ny Excel
                    </label>
                    <input type="file" id="excelFileMpiandraikitra" accept=".xlsx,.xls,.csv" style="display: none;" onchange="uploadExcelMpiandraikitra(this)">
                    <button class="btn-primary" onclick="openAddModal()">
                        <i class="fas fa-plus"></i>
                        Hanampy
                    </button>
                </div>
            </div>

            <!-- Filtres -->
            <div class="filters-section">
                <div class="filters-row">
                    <div class="filter-group">
                        <label>Fikarohana</label>
                        <div class="search-filter">
                            <i class="fas fa-search"></i>
                            <input type="text" id="searchInput" placeholder="Anarana, fanampin'anarana, totem..." onkeyup="applyFilters()">
                        </div>
                    </div>
                    <!-- Filtre Fivondronana (admin seulement) -->
                    <div class="filter-group" th:if="${isAdmin}">
                        <label>Fivondronana</label>
                        <select id="filterFivondronana" onchange="applyFilters()">
                            <option value="">Ny Fivondronana rehetra</option>
                            <option th:each="fiv : ${fivondronana}" th:value="${fiv.nom}" th:text="${fiv.nom}"></option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Faritra</label>
                        <select id="filterSecteur" onchange="applyFilters()">
                            <option value="">Ny Faritra rehetra</option>
                            <option th:each="secteur : ${secteurs}" th:value="${secteur.nom}" th:text="${secteur.nom}"></option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>FAFI</label>
                        <select id="filterFafi" onchange="applyFilters()">
                            <option value="">Ny rehetra</option>
                            <option value="Eny">Eny</option>
                            <option value="Tsia">Tsia</option>
                        </select>
                    </div>
                </div>
                <div class="filters-actions">
                    <button class="btn-secondary" onclick="resetFilters()">
                        <i class="fas fa-undo"></i>
                        Averina
                    </button>
                    <button class="btn-pdf" onclick="exportToPDF()">
                        <i class="fas fa-file-pdf"></i>
                        Alaina PDF
                    </button>
                </div>
            </div>

            <!-- Tableau des Responsables -->
            <div class="table-card">
                <div class="table-container">
                    <table class="data-table" id="responsablesTable">
                        <thead>
                            <tr>
                                <th class="sortable" onclick="sortTable(0)">Sary</th>
                                <th class="sortable" onclick="sortTable(1)">Anarana <i class="fas fa-sort"></i></th>
                                <th class="sortable" onclick="sortTable(2)">Fanampin'anarana <i class="fas fa-sort"></i></th>
                                <th class="sortable" onclick="sortTable(3)">Totem <i class="fas fa-sort"></i></th>
                                <th class="sortable" onclick="sortTable(4)">Daty nahaterahana <i class="fas fa-sort"></i></th>
                                <th class="sortable" onclick="sortTable(5)">N° CIN <i class="fas fa-sort"></i></th>
                                <th class="sortable" onclick="sortTable(6)">Finday <i class="fas fa-sort"></i></th>
                                <th class="sortable" onclick="sortTable(7)">Faritra <i class="fas fa-sort"></i></th>
                                <th class="sortable" onclick="sortTable(8)">Andraikitra <i class="fas fa-sort"></i></th>
                                <th class="sortable" onclick="sortTable(9)" th:if="${isAdmin}">Fivondronana <i class="fas fa-sort"></i></th>
                                <th class="sortable" th:onclick="${isAdmin} ? 'sortTable(10)' : 'sortTable(9)'">Fanekena <i class="fas fa-sort"></i></th>
                                <th class="sortable" th:onclick="${isAdmin} ? 'sortTable(11)' : 'sortTable(10)'">Laharana FAFI <i class="fas fa-sort"></i></th>
                                <th class="sortable" th:onclick="${isAdmin} ? 'sortTable(12)' : 'sortTable(11)'">FAFI <i class="fas fa-sort"></i></th>
                                <th>Asa</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Message si aucune donnée -->
                            <tr th:if="${#lists.isEmpty(responsables)}">
                                <td colspan="14" class="empty-message">
                                    <i class="fas fa-inbox"></i>
                                    <p>Tsy misy Mpiandraikitra hita</p>
                                </td>
                            </tr>
                            <!-- Données dynamiques -->
                            <tr th:each="resp : ${responsables}" 
                                th:data-id="${resp.id}"
                                th:data-nom="${resp.nom}"
                                th:data-prenom="${resp.prenom}"
                                th:data-totem="${resp.totem}"
                                th:data-datenaissance="${resp.dateNaissance}"
                                th:data-numerocin="${resp.numeroCin}"
                                th:data-numerotelephone="${resp.numeroTelephone}"
                                th:data-nompere="${resp.nomPere}"
                                th:data-nommere="${resp.nomMere}"
                                th:data-datefanekena="${resp.dateFanekena}"
                                th:data-secteur="${resp.secteur != null ? resp.secteur.nom : ''}"
                                th:data-secteurid="${resp.secteur != null ? resp.secteur.id : ''}"
                                th:data-andraikitra="${resp.andraikitra != null ? resp.andraikitra.nom : ''}"
                                th:data-andraikitraid="${resp.andraikitra != null ? resp.andraikitra.id : ''}"
                                th:data-fivondronana="${resp.fivondronana != null ? resp.fivondronana.nom : ''}"
                                th:data-fivondronanaid="${resp.fivondronana != null ? resp.fivondronana.id : ''}"
                                th:data-fafi="${resp.fafi != null && resp.fafi.statut == 'Active' ? 'Eny' : 'Tsia'}">
                                <td>
                                    <img th:if="${resp.image != null and !resp.image.isEmpty()}" th:src="${resp.image}" class="avatar" alt="Photo">
                                    <img th:unless="${resp.image != null and !resp.image.isEmpty()}" 
                                         th:src="'https://ui-avatars.com/api/?name=' + ${resp.prenom} + '+' + ${resp.nom} + '&background=667eea&color=fff'" 
                                         class="avatar" alt="Photo">
                                </td>
                                <td th:text="${resp.nom}">-</td>
                                <td th:text="${resp.prenom}">-</td>
                                <td th:text="${resp.totem}">-</td>
                                <td th:text="${resp.dateNaissance != null ? #temporals.format(resp.dateNaissance, 'dd/MM/yyyy') : '-'}">-</td>
                                <td th:text="${resp.numeroCin}">-</td>
                                <td th:text="${resp.numeroTelephone}">-</td>
                                <td th:text="${resp.secteur != null ? resp.secteur.nom : '-'}">-</td>
                                <td th:text="${resp.andraikitra != null ? resp.andraikitra.nom : '-'}">-</td>
                                <td th:if="${isAdmin}" th:text="${resp.fivondronana != null ? resp.fivondronana.nom : '-'}">-</td>
                                <td th:text="${resp.dateFanekena != null ? #temporals.format(resp.dateFanekena, 'dd/MM/yyyy') : '-'}">-</td>
                                <td th:text="${resp.fafi != null && resp.fafi.numeroFafi != null ? resp.fafi.numeroFafi : '-'}">-</td>
                                <td>
                                    <span th:if="${resp.fafi != null && resp.fafi.statut == 'Active'}" class="status-badge delivered">Eny</span>
                                    <span th:unless="${resp.fafi != null && resp.fafi.statut == 'Active'}" class="status-badge pending">Tsia</span>
                                </td>
                                <td class="actions-cell">
                                    <button class="btn-icon edit-btn" title="Hanova" th:data-id="${resp.id}"><i class="fas fa-edit"></i></button>
                                    <button class="btn-icon fafi-btn" title="Hanova FAFI" th:data-id="${resp.id}" 
                                            th:data-datepaiement="${resp.fafi != null && resp.fafi.datePaiement != null ? #temporals.format(resp.fafi.datePaiement, 'yyyy-MM-dd') : ''}"
                                            th:data-montant="${resp.fafi != null && resp.fafi.montant != null ? resp.fafi.montant : ''}"
                                            th:data-statut="${resp.fafi != null && resp.fafi.statut != null ? resp.fafi.statut : 'Inactive'}"
                                            th:data-numerofafi="${resp.fafi != null && resp.fafi.numeroFafi != null ? resp.fafi.numeroFafi : ''}">
                                        <i class="fas fa-money-bill-wave"></i>
                                    </button>
                                    <form th:action="@{/responsables/supprimer}" method="post" style="display: inline;">
                                        <input type="hidden" name="id" th:value="${resp.id}">
                                        <button type="submit" class="btn-icon danger" title="Hamafa" onclick="return confirm('Azo antoka ve ianao fa te-hamafa ity Mpiandraikitra ity ?')"><i class="fas fa-trash"></i></button>
                                    </form>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- Pagination -->
                <div class="table-footer">
                    <div class="rows-per-page">
                        <span>Andalana isaky ny pejy:</span>
                        <select>
                            <option>10</option>
                            <option>25</option>
                            <option>50</option>
                        </select>
                    </div>
                    <div class="pagination">
                        <span id="paginationInfo" th:text="'1-' + ${totalCount} + ' amin\'ny ' + ${totalCount}">1-0 amin'ny 0</span>
                        <button class="btn-icon" disabled><i class="fas fa-chevron-left"></i></button>
                        <button class="btn-icon"><i class="fas fa-chevron-right"></i></button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div th:replace="~{fragments/footer :: footer}"></div>
    </div>

    <!-- Modal Ajouter Responsable -->
    <div id="addModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-user-plus"></i> Hanampy Mpiandraikitra</h2>
                <button class="modal-close" onclick="closeAddModal()">&times;</button>
            </div>
            <form th:action="@{/responsables/ajouter}" method="post">
                <div class="modal-body">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="nom">Anarana <span class="required">*</span></label>
                            <input type="text" id="nom" name="nom" required placeholder="Ohatra: RAKOTO">
                        </div>
                        <div class="form-group">
                            <label for="prenom">Fanampin'anarana <span class="required">*</span></label>
                            <input type="text" id="prenom" name="prenom" required placeholder="Ohatra: Jean">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="totem">Totem</label>
                            <input type="text" id="totem" name="totem" placeholder="Ohatra: Akanga">
                        </div>
                        <div class="form-group">
                            <label for="dateNaissance">Daty nahaterahana</label>
                            <input type="date" id="dateNaissance" name="dateNaissance">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="numeroCin">Laharana CIN</label>
                            <input type="text" id="numeroCin" name="numeroCin" placeholder="Ohatra: 101 251 456 789">
                        </div>
                        <div class="form-group">
                            <label for="numeroTelephone">Finday</label>
                            <input type="text" id="numeroTelephone" name="numeroTelephone" placeholder="Ohatra: 034 12 345 67">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="nomPere">Anaran'ny Ray</label>
                            <input type="text" id="nomPere" name="nomPere" placeholder="Ohatra: Pierre Rakoto">
                        </div>
                        <div class="form-group">
                            <label for="nomMere">Anaran'ny Reny</label>
                            <input type="text" id="nomMere" name="nomMere" placeholder="Ohatra: Marie Rasoa">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="secteurId">Faritra</label>
                            <select id="secteurId" name="secteurId">
                                <option value="">-- Mifidy --</option>
                                <option th:each="secteur : ${secteurs}" th:value="${secteur.id}" th:text="${secteur.nom}"></option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="andraikitraId">Andraikitra</label>
                            <select id="andraikitraId" name="andraikitraId">
                                <option value="">-- Mifidy --</option>
                                <option th:each="andraikitra : ${andraikitra}" th:value="${andraikitra.id}" th:text="${andraikitra.nom}"></option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="dateFanekena">Daty Fanekena</label>
                            <input type="date" id="dateFanekena" name="dateFanekena">
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-secondary" onclick="closeAddModal()">
                        <i class="fas fa-times"></i> Hanafoana
                    </button>
                    <button type="submit" class="btn-primary">
                        <i class="fas fa-save"></i> Tehirizina
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Modifier Responsable -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-user-edit"></i> Hanova Mpiandraikitra</h2>
                <button class="modal-close" onclick="closeEditModal()">&times;</button>
            </div>
            <form th:action="@{/responsables/modifier}" method="post">
                <input type="hidden" id="editId" name="id">
                <div class="modal-body">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="editNom">Anarana <span class="required">*</span></label>
                            <input type="text" id="editNom" name="nom" required>
                        </div>
                        <div class="form-group">
                            <label for="editPrenom">Fanampin'anarana <span class="required">*</span></label>
                            <input type="text" id="editPrenom" name="prenom" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="editTotem">Totem</label>
                            <input type="text" id="editTotem" name="totem">
                        </div>
                        <div class="form-group">
                            <label for="editDateNaissance">Daty nahaterahana</label>
                            <input type="date" id="editDateNaissance" name="dateNaissance">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="editNumeroCin">Laharana CIN</label>
                            <input type="text" id="editNumeroCin" name="numeroCin">
                        </div>
                        <div class="form-group">
                            <label for="editNumeroTelephone">Finday</label>
                            <input type="text" id="editNumeroTelephone" name="numeroTelephone">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="editNomPere">Anaran'ny Ray</label>
                            <input type="text" id="editNomPere" name="nomPere">
                        </div>
                        <div class="form-group">
                            <label for="editNomMere">Anaran'ny Reny</label>
                            <input type="text" id="editNomMere" name="nomMere">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="editSecteurId">Faritra</label>
                            <select id="editSecteurId" name="secteurId">
                                <option value="">-- Mifidy --</option>
                                <option th:each="secteur : ${secteurs}" th:value="${secteur.id}" th:text="${secteur.nom}"></option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="editAndraikitraId">Andraikitra</label>
                            <select id="editAndraikitraId" name="andraikitraId">
                                <option value="">-- Mifidy --</option>
                                <option th:each="andraikitra : ${andraikitra}" th:value="${andraikitra.id}" th:text="${andraikitra.nom}"></option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="editDateFanekena">Daty Fanekena</label>
                            <input type="date" id="editDateFanekena" name="dateFanekena">
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-secondary" onclick="closeEditModal()">
                        <i class="fas fa-times"></i> Hanafoana
                    </button>
                    <button type="submit" class="btn-primary">
                        <i class="fas fa-save"></i> Tehirizina
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Modifier FAFI -->
    <div id="fafiModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-money-bill-wave"></i> Hanova FAFI</h2>
                <button class="modal-close" onclick="closeFafiModal()">&times;</button>
            </div>
            <form th:action="@{/responsables/modifier-fafi}" method="post">
                <input type="hidden" id="fafiPersonneId" name="personneId">
                <div class="modal-body">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="fafiDatePaiement">Daty fandoavana</label>
                            <input type="date" id="fafiDatePaiement" name="datePaiement">
                        </div>
                        <div class="form-group">
                            <label for="fafiMontant">Vola</label>
                            <input type="number" id="fafiMontant" name="montant" step="0.01" min="0" placeholder="Ohatra: 8000.00">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="fafiStatut">Sata</label>
                            <select id="fafiStatut" name="statut">
                                <option th:each="statut : ${fafiStatuts}" 
                                        th:value="${statut}" 
                                        th:text="${statut == 'Active' ? 'Active (Eny)' : (statut == 'Inactive' ? 'Inactive (Tsia)' : statut)}"></option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="fafiNumero">Laharana FAFI</label>
                            <input type="text" id="fafiNumero" name="numeroFafi" placeholder="Ohatra: FAFI-2024-001">
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-secondary" onclick="closeFafiModal()">
                        <i class="fas fa-times"></i> Hanafoana
                    </button>
                    <button type="submit" class="btn-primary">
                        <i class="fas fa-save"></i> Tehirizina
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Toggle sidebar mobile
        function toggleSidebar() {
            const sidebar = document.querySelector('.sidebar');
            sidebar.classList.toggle('active');
        }

        // Toggle sidebar collapse/expand
        function toggleSidebarCollapse() {
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.querySelector('.main-content');
            const toggleIcon = sidebar.querySelector('.sidebar-toggle i');
            
            sidebar.classList.toggle('collapsed');
            mainContent.classList.toggle('sidebar-collapsed');
            
            if (sidebar.classList.contains('collapsed')) {
                toggleIcon.classList.remove('fa-chevron-left');
                toggleIcon.classList.add('fa-chevron-right');
                localStorage.setItem('sidebarCollapsed', 'true');
            } else {
                toggleIcon.classList.remove('fa-chevron-right');
                toggleIcon.classList.add('fa-chevron-left');
                localStorage.setItem('sidebarCollapsed', 'false');
            }
        }
        
        // Restore sidebar state
        document.addEventListener('DOMContentLoaded', function() {
            const isCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';
            if (isCollapsed) {
                const sidebar = document.getElementById('sidebar');
                const mainContent = document.querySelector('.main-content');
                const toggleIcon = sidebar.querySelector('.sidebar-toggle i');
                
                sidebar.classList.add('collapsed');
                mainContent.classList.add('sidebar-collapsed');
                toggleIcon.classList.remove('fa-chevron-left');
                toggleIcon.classList.add('fa-chevron-right');
            }
            
            // Auto-hide alerts after 5 seconds
            setTimeout(() => {
                document.querySelectorAll('.alert').forEach(alert => {
                    alert.style.opacity = '0';
                    setTimeout(() => alert.remove(), 300);
                });
            }, 5000);

            // Attach edit button listeners
            document.querySelectorAll('.edit-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const row = this.closest('tr');
                    openEditModal(row);
                });
            });

            // Attach FAFI button listeners
            document.querySelectorAll('.fafi-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    openFafiModal(this);
                });
            });
        });

        // Tri du tableau
        let sortDirection = {};
        
        function sortTable(columnIndex) {
            const table = document.getElementById('responsablesTable');
            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.querySelectorAll('tr:not(.empty-message)'));
            
            sortDirection[columnIndex] = !sortDirection[columnIndex];
            const direction = sortDirection[columnIndex] ? 1 : -1;
            
            rows.sort((a, b) => {
                const aValue = a.cells[columnIndex].textContent.trim();
                const bValue = b.cells[columnIndex].textContent.trim();
                
                if (aValue.match(/^\d{2}\/\d{2}\/\d{4}$/)) {
                    const aDate = aValue.split('/').reverse().join('-');
                    const bDate = bValue.split('/').reverse().join('-');
                    return direction * (new Date(aDate) - new Date(bDate));
                }
                
                return direction * aValue.localeCompare(bValue, 'fr');
            });
            
            document.querySelectorAll('.sortable i').forEach(icon => {
                icon.className = 'fas fa-sort';
            });
            const header = table.querySelectorAll('th')[columnIndex];
            const icon = header.querySelector('i');
            if (icon) {
                icon.className = sortDirection[columnIndex] ? 'fas fa-sort-up' : 'fas fa-sort-down';
            }
            
            rows.forEach(row => tbody.appendChild(row));
        }

        // Appliquer tous les filtres
        function applyFilters() {
            const searchValue = document.getElementById('searchInput').value.toLowerCase();
            const secteurValue = document.getElementById('filterSecteur').value;
            const fafiValue = document.getElementById('filterFafi').value;
            // Filtre Fivondronana (admin seulement)
            const filterFivondronanaEl = document.getElementById('filterFivondronana');
            const fivondronanaValue = filterFivondronanaEl ? filterFivondronanaEl.value : '';
            
            const table = document.getElementById('responsablesTable');
            const rows = table.querySelectorAll('tbody tr:not(.empty-message)');
            let visibleCount = 0;
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                const secteur = row.getAttribute('data-secteur') || '';
                const fafi = row.getAttribute('data-fafi') || '';
                const fivondronana = row.getAttribute('data-fivondronana') || '';
                
                const matchSearch = !searchValue || text.includes(searchValue);
                const matchSecteur = !secteurValue || secteur === secteurValue;
                const matchFafi = !fafiValue || fafi === fafiValue;
                const matchFivondronana = !fivondronanaValue || fivondronana === fivondronanaValue;
                
                if (matchSearch && matchSecteur && matchFafi && matchFivondronana) {
                    row.style.display = '';
                    visibleCount++;
                } else {
                    row.style.display = 'none';
                }
            });
            
            document.getElementById('recordCount').textContent = visibleCount + ' Mpiandraikitra';
            document.getElementById('paginationInfo').textContent = '1-' + visibleCount + " amin'ny " + visibleCount;
        }

        // Réinitialiser les filtres
        function resetFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('filterSecteur').value = '';
            document.getElementById('filterFafi').value = '';
            // Réinitialiser le filtre Fivondronana si présent (admin seulement)
            const filterFivondronanaEl = document.getElementById('filterFivondronana');
            if (filterFivondronanaEl) filterFivondronanaEl.value = '';
            applyFilters();
        }

        // Modal Ajouter functions
        function openAddModal() {
            document.getElementById('addModal').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeAddModal() {
            document.getElementById('addModal').classList.remove('active');
            document.body.style.overflow = '';
        }

        // Modal Modifier functions
        function openEditModal(row) {
            document.getElementById('editId').value = row.dataset.id;
            document.getElementById('editNom').value = row.dataset.nom || '';
            document.getElementById('editPrenom').value = row.dataset.prenom || '';
            document.getElementById('editTotem').value = row.dataset.totem || '';
            document.getElementById('editDateNaissance').value = row.dataset.datenaissance || '';
            document.getElementById('editNumeroCin').value = row.dataset.numerocin || '';
            document.getElementById('editNumeroTelephone').value = row.dataset.numerotelephone || '';
            document.getElementById('editNomPere').value = row.dataset.nompere || '';
            document.getElementById('editNomMere').value = row.dataset.nommere || '';
            document.getElementById('editDateFanekena').value = row.dataset.datefanekena || '';
            document.getElementById('editSecteurId').value = row.dataset.secteurid || '';
            document.getElementById('editAndraikitraId').value = row.dataset.andraikitraid || '';
            
            document.getElementById('editModal').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.remove('active');
            document.body.style.overflow = '';
        }

        // Modal FAFI functions
        function openFafiModal(button) {
            const personneId = button.dataset.id;
            const datePaiement = button.dataset.datepaiement || '';
            const montant = button.dataset.montant || '';
            const statut = button.dataset.statut || 'Inactive';
            const numeroFafi = button.dataset.numerofafi || '';
            
            document.getElementById('fafiPersonneId').value = personneId;
            document.getElementById('fafiDatePaiement').value = datePaiement;
            document.getElementById('fafiMontant').value = montant;
            document.getElementById('fafiStatut').value = statut;
            document.getElementById('fafiNumero').value = numeroFafi;
            
            document.getElementById('fafiModal').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeFafiModal() {
            document.getElementById('fafiModal').classList.remove('active');
            document.body.style.overflow = '';
        }

        // Close modals on outside click
        document.getElementById('addModal').addEventListener('click', function(e) {
            if (e.target === this) closeAddModal();
        });
        document.getElementById('editModal').addEventListener('click', function(e) {
            if (e.target === this) closeEditModal();
        });
        document.getElementById('fafiModal').addEventListener('click', function(e) {
            if (e.target === this) closeFafiModal();
        });

        // Close modals on Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeAddModal();
                closeEditModal();
                closeFafiModal();
            }
        });

        // Fonction helper pour convertir une image en base64
        function imageToBase64(url, callback) {
            fetch(url)
                .then(response => response.blob())
                .then(blob => {
                    const reader = new FileReader();
                    reader.onloadend = function() {
                        callback(reader.result);
                    };
                    reader.onerror = function() {
                        callback(null);
                    };
                    reader.readAsDataURL(blob);
                })
                .catch(error => {
                    console.error('Hadisoana rehefa mampiditra ny sary:', error);
                    callback(null);
                });
        }

        // Export PDF
        function exportToPDF() {
            const table = document.getElementById('responsablesTable');
            const rows = table.querySelectorAll('tbody tr:not(.empty-message)');
            const visibleRows = Array.from(rows).filter(row => row.style.display !== 'none');
            
            if (visibleRows.length === 0) {
                alert('Tsy misy angona hivoaka');
                return;
            }

            const secteur = document.getElementById('filterSecteur').value;
            const fafi = document.getElementById('filterFafi').value;
            
            let filterTitle = 'Lisitry ny Mpiandraikitra';
            let filters = [];
            if (secteur) filters.push('Faritra: ' + secteur);
            if (fafi) filters.push('FAFI: ' + fafi);
            
            // Charger l'image et la convertir en base64
            const imageUrl = window.location.origin + '/images/top-tily.jpg';
            imageToBase64(imageUrl, function(imageBase64) {
                let printContent = `
                    <html>
                    <head>
                        <title>Alaina Mpiandraikitra - Tily</title>
                        <style>
                            body { font-family: Arial, sans-serif; padding: 20px; }
                            .header-image { width: 100%; max-width: 800px; margin: 0 auto 20px; display: block; }
                            h1 { color: #0B1739; font-size: 24px; margin-bottom: 5px; }
                            .filters { color: #666; font-size: 12px; margin-bottom: 20px; }
                            .date { color: #666; font-size: 11px; margin-bottom: 20px; }
                            table { width: 100%; border-collapse: collapse; font-size: 11px; }
                            th { background: #0B1739; color: white; padding: 10px 8px; text-align: left; }
                            td { padding: 8px; border-bottom: 1px solid #ddd; }
                            tr:nth-child(even) { background: #f9f9f9; }
                            .footer { margin-top: 30px; text-align: center; color: #666; font-size: 10px; }
                        </style>
                    </head>
                    <body>
                        ${imageBase64 ? '<img src="' + imageBase64 + '" alt="Tily" class="header-image">' : ''}
                        <h1>${filterTitle}</h1>
                        ${filters.length > 0 ? '<p class="filters">Sivana: ' + filters.join(' | ') + '</p>' : ''}
                        <p class="date">Voaloa tamin'ny: ${new Date().toLocaleDateString('fr-FR')} amin'ny ${new Date().toLocaleTimeString('fr-FR')}</p>
                    <table>
                        <thead>
                            <tr>
                                <th>Anarana</th>
                                <th>Fanampin'anarana</th>
                                <th>Totem</th>
                                <th>Daty nahaterahana</th>
                                <th>N° CIN</th>
                                <th>Finday</th>
                                <th>Faritra</th>
                                <th>Andraikitra</th>
                                <th>Fanekena</th>
                                <th>Laharana FAFI</th>
                                <th>FAFI</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            // Déterminer si admin (colonne Fivondronana présente)
            const isAdmin = document.getElementById('filterFivondronana') !== null;
            
            visibleRows.forEach(row => {
                const cells = row.querySelectorAll('td');
                // Indices des colonnes selon admin ou non
                const fanekenaIdx = isAdmin ? 10 : 9;
                const numeroFafiIdx = isAdmin ? 11 : 10;
                const fafiIdx = isAdmin ? 12 : 11;
                printContent += `
                    <tr>
                        <td>${cells[1].textContent}</td>
                        <td>${cells[2].textContent}</td>
                        <td>${cells[3].textContent}</td>
                        <td>${cells[4].textContent}</td>
                        <td>${cells[5].textContent}</td>
                        <td>${cells[6].textContent}</td>
                        <td>${cells[7].textContent}</td>
                        <td>${cells[8].textContent}</td>
                        <td>${cells[fanekenaIdx].textContent}</td>
                        <td>${cells[numeroFafiIdx].textContent}</td>
                        <td>${cells[fafiIdx].textContent}</td>
                    </tr>
                `;
            });
            
                printContent += `
                            </tbody>
                        </table>
                        <div class="footer">
                            <p>Total: ${visibleRows.length} Mpiandraikitra - Tily © ${new Date().getFullYear()}</p>
                        </div>
                    </body>
                    </html>
                `;
                
                const printWindow = window.open('', '_blank');
                printWindow.document.write(printContent);
                printWindow.document.close();
                printWindow.focus();
                setTimeout(() => printWindow.print(), 250);
            });
        }
    </script>

    <script>
        function uploadExcelMpiandraikitra(input) {
            if (input.files && input.files[0]) {
                const formData = new FormData();
                formData.append('file', input.files[0]);
                
                // Afficher un message de chargement
                const loadingMsg = document.createElement('div');
                loadingMsg.className = 'alert alert-info';
                loadingMsg.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Import en cours...';
                document.querySelector('.dashboard-content').insertBefore(loadingMsg, document.querySelector('.dashboard-content').firstChild);
                
                fetch('/responsables/import-excel', {
                    method: 'POST',
                    body: formData
                })
                .then(response => {
                    if (response.redirected) {
                        window.location.href = response.url;
                    }
                })
                .catch(error => {
                    console.error('Erreur:', error);
                    alert('Erreur lors de l\'import: ' + error.message);
                });
            }
        }
    </script>
</body>
</html>
