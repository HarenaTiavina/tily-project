<!DOCTYPE html>
<html lang="mg" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Beazina - Tily</title>
    <link rel="stylesheet" th:href="@{/css/dashboard.css}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <!-- Sidebar -->
    <div th:replace="~{fragments/sidebar :: sidebar('eleves')}"></div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Topbar -->
        <div th:replace="~{fragments/topbar :: topbar(${pageTitle}, ${userName})}"></div>

        <!-- Page Content -->
        <div class="dashboard-content">
            <!-- Messages de notification -->
            <div th:if="${successMessage}" class="alert alert-success">
                <i class="fas fa-check-circle"></i>
                <span th:text="${successMessage}"></span>
                <button class="alert-close" onclick="this.parentElement.remove()">&times;</button>
            </div>
            <div th:if="${errorMessage}" class="alert alert-error">
                <i class="fas fa-exclamation-circle"></i>
                <span th:text="${errorMessage}"></span>
                <button class="alert-close" onclick="this.parentElement.remove()">&times;</button>
            </div>

            <!-- Header avec actions -->
            <div class="page-header">
                <div class="header-left">
                    <h2>Lisitry ny Beazina</h2>
                    <span class="record-count" id="recordCount" th:text="${totalCount} + ' Beazina'">0 Beazina</span>
                </div>
                <div class="header-actions">
                    <button class="btn-primary" onclick="openAddModal()">
                        <i class="fas fa-plus"></i>
                        Hanampy
                    </button>
                </div>
            </div>

            <!-- Filtres -->
            <div class="filters-section">
                <div class="filters-row">
                    <div class="filter-group">
                        <label>Fikarohana</label>
                        <div class="search-filter">
                            <i class="fas fa-search"></i>
                            <input type="text" id="searchInput" placeholder="Anarana, fanampin'anarana, totem..." onkeyup="applyFilters()">
                        </div>
                    </div>
                    <div class="filter-group">
                        <label>Sektora</label>
                        <select id="filterSecteur" onchange="applyFilters()">
                            <option value="">Ny sektora rehetra</option>
                            <option th:each="secteur : ${secteurs}" th:value="${secteur.nom}" th:text="${secteur.nom}"></option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Fizarana</label>
                        <select id="filterFizarana" onchange="applyFilters()">
                            <option value="">Ny fizarana rehetra</option>
                            <option th:each="fizarana : ${fizarana}" th:value="${fizarana.nom}" th:text="${fizarana.nom}"></option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Ambaratonga</label>
                        <select id="filterAmbaratonga" onchange="applyFilters()">
                            <option value="">Ny ambaratonga rehetra</option>
                            <option value="Louveteau">Louveteau</option>
                            <option value="Éclaireur">Éclaireur</option>
                            <option value="Routier">Routier</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Fiantohana</label>
                        <select id="filterAssurance" onchange="applyFilters()">
                            <option value="">Ny rehetra</option>
                            <option value="Oui">Eny</option>
                            <option value="Non">Tsia</option>
                        </select>
                    </div>
                </div>
                <div class="filters-actions">
                    <button class="btn-secondary" onclick="resetFilters()">
                        <i class="fas fa-undo"></i>
                        Averina
                    </button>
                    <button class="btn-pdf" onclick="exportToPDF()">
                        <i class="fas fa-file-pdf"></i>
                        Alaina PDF
                    </button>
                </div>
            </div>

            <!-- Tableau des Élèves -->
            <div class="table-card">
                <div class="table-container">
                    <table class="data-table" id="elevesTable">
                        <thead>
                            <tr>
                                <th class="sortable" onclick="sortTable(0)">Sary</th>
                                <th class="sortable" onclick="sortTable(1)">Anarana <i class="fas fa-sort"></i></th>
                                <th class="sortable" onclick="sortTable(2)">Fanampin'anarana <i class="fas fa-sort"></i></th>
                                <th class="sortable" onclick="sortTable(3)">Totem <i class="fas fa-sort"></i></th>
                                <th class="sortable" onclick="sortTable(4)">Daty nahaterahana <i class="fas fa-sort"></i></th>
                                <th class="sortable" onclick="sortTable(5)">Anaran'ny Ray <i class="fas fa-sort"></i></th>
                                <th class="sortable" onclick="sortTable(6)">Anaran'ny Reny <i class="fas fa-sort"></i></th>
                                <th class="sortable" onclick="sortTable(7)">Sektora <i class="fas fa-sort"></i></th>
                                <th class="sortable" onclick="sortTable(8)">Fizarana <i class="fas fa-sort"></i></th>
                                <th class="sortable" onclick="sortTable(9)">Ambaratonga <i class="fas fa-sort"></i></th>
                                <th class="sortable" onclick="sortTable(10)">Fanekena <i class="fas fa-sort"></i></th>
                                <th class="sortable" onclick="sortTable(11)">Fiantohana <i class="fas fa-sort"></i></th>
                                <th>Asa</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Message si aucune donnée -->
                            <tr th:if="${#lists.isEmpty(eleves)}">
                                <td colspan="13" class="empty-message">
                                    <i class="fas fa-inbox"></i>
                                    <p>Tsy misy Beazina hita</p>
                                </td>
                            </tr>
                            <!-- Données dynamiques -->
                            <tr th:each="eleve : ${eleves}" 
                                th:data-id="${eleve.id}"
                                th:data-nom="${eleve.nom}"
                                th:data-prenom="${eleve.prenom}"
                                th:data-totem="${eleve.totem}"
                                th:data-datenaissance="${eleve.dateNaissance}"
                                th:data-nompere="${eleve.nomPere}"
                                th:data-nommere="${eleve.nomMere}"
                                th:data-datefanekena="${eleve.dateFanekena}"
                                th:data-secteur="${eleve.secteur != null ? eleve.secteur.nom : ''}"
                                th:data-secteurid="${eleve.secteur != null ? eleve.secteur.id : ''}"
                                th:data-fizarana="${eleve.fizarana != null ? eleve.fizarana.nom : ''}"
                                th:data-fizaranaid="${eleve.fizarana != null ? eleve.fizarana.id : ''}"
                                th:data-ambaratonga="${eleve.ambaratonga}"
                                th:data-assurance="${eleve.assurance != null && eleve.assurance.statut == 'Active' ? 'Oui' : 'Non'}">
                                <td>
                                    <img th:if="${eleve.image != null and !eleve.image.isEmpty()}" th:src="${eleve.image}" class="avatar" alt="Photo">
                                    <img th:unless="${eleve.image != null and !eleve.image.isEmpty()}" 
                                         th:src="'https://ui-avatars.com/api/?name=' + ${eleve.prenom} + '+' + ${eleve.nom} + '&background=4facfe&color=fff'" 
                                         class="avatar" alt="Photo">
                                </td>
                                <td th:text="${eleve.nom}">-</td>
                                <td th:text="${eleve.prenom}">-</td>
                                <td th:text="${eleve.totem}">-</td>
                                <td th:text="${eleve.dateNaissance != null ? #temporals.format(eleve.dateNaissance, 'dd/MM/yyyy') : '-'}">-</td>
                                <td th:text="${eleve.nomPere}">-</td>
                                <td th:text="${eleve.nomMere}">-</td>
                                <td th:text="${eleve.secteur != null ? eleve.secteur.nom : '-'}">-</td>
                                <td th:text="${eleve.fizarana != null ? eleve.fizarana.nom : '-'}">-</td>
                                <td>
                                    <span th:if="${eleve.ambaratonga == 'Louveteau'}" class="badge-niveau louveteau">Louveteau</span>
                                    <span th:if="${eleve.ambaratonga == 'Éclaireur'}" class="badge-niveau eclaireur">Éclaireur</span>
                                    <span th:if="${eleve.ambaratonga == 'Routier'}" class="badge-niveau routier">Routier</span>
                                    <span th:if="${eleve.ambaratonga == null}">-</span>
                                </td>
                                <td th:text="${eleve.dateFanekena != null ? #temporals.format(eleve.dateFanekena, 'dd/MM/yyyy') : '-'}">-</td>
                                <td>
                                    <span th:if="${eleve.assurance != null && eleve.assurance.statut == 'Active'}" class="status-badge delivered">Eny</span>
                                    <span th:unless="${eleve.assurance != null && eleve.assurance.statut == 'Active'}" class="status-badge pending">Tsia</span>
                                </td>
                                <td class="actions-cell">
                                    <button class="btn-icon edit-btn" title="Hanova" th:data-id="${eleve.id}"><i class="fas fa-edit"></i></button>
                                    <form th:action="@{/eleves/supprimer}" method="post" style="display: inline;">
                                        <input type="hidden" name="id" th:value="${eleve.id}">
                                        <button type="submit" class="btn-icon danger" title="Hamafa" onclick="return confirm('Azo antoka ve ianao fa te-hamafa ity Beazina ity ?')"><i class="fas fa-trash"></i></button>
                                    </form>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- Pagination -->
                <div class="table-footer">
                    <div class="rows-per-page">
                        <span>Andalana isaky ny pejy:</span>
                        <select>
                            <option>10</option>
                            <option>25</option>
                            <option>50</option>
                        </select>
                    </div>
                    <div class="pagination">
                        <span id="paginationInfo" th:text="'1-' + ${totalCount} + ' amin\'ny ' + ${totalCount}">1-0 amin'ny 0</span>
                        <button class="btn-icon" disabled><i class="fas fa-chevron-left"></i></button>
                        <button class="btn-icon"><i class="fas fa-chevron-right"></i></button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div th:replace="~{fragments/footer :: footer}"></div>
    </div>

    <!-- Modal Ajouter Élève -->
    <div id="addModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-user-graduate"></i> Hanampy Beazina</h2>
                <button class="modal-close" onclick="closeAddModal()">&times;</button>
            </div>
            <form th:action="@{/eleves/ajouter}" method="post">
                <div class="modal-body">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="nom">Anarana <span class="required">*</span></label>
                            <input type="text" id="nom" name="nom" required placeholder="Ohatra: RAKOTO">
                        </div>
                        <div class="form-group">
                            <label for="prenom">Fanampin'anarana <span class="required">*</span></label>
                            <input type="text" id="prenom" name="prenom" required placeholder="Ohatra: Aina">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="totem">Totem</label>
                            <input type="text" id="totem" name="totem" placeholder="Ohatra: Akanga">
                        </div>
                        <div class="form-group">
                            <label for="dateNaissance">Daty nahaterahana</label>
                            <input type="date" id="dateNaissance" name="dateNaissance">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="nomPere">Anaran'ny Ray</label>
                            <input type="text" id="nomPere" name="nomPere" placeholder="Ohatra: Jean Rakoto">
                        </div>
                        <div class="form-group">
                            <label for="nomMere">Anaran'ny Reny</label>
                            <input type="text" id="nomMere" name="nomMere" placeholder="Ohatra: Marie Rasoa">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="secteurId">Sektora</label>
                            <select id="secteurId" name="secteurId">
                                <option value="">-- Mifidy --</option>
                                <option th:each="secteur : ${secteurs}" th:value="${secteur.id}" th:text="${secteur.nom}"></option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="fizaranaId">Fizarana</label>
                            <select id="fizaranaId" name="fizaranaId">
                                <option value="">-- Mifidy --</option>
                                <option th:each="fizarana : ${fizarana}" th:value="${fizarana.id}" th:text="${fizarana.nom}"></option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="ambaratonga">Ambaratonga</label>
                            <select id="ambaratonga" name="ambaratonga">
                                <option value="">-- Mifidy --</option>
                                <option value="Louveteau">Louveteau</option>
                                <option value="Éclaireur">Éclaireur</option>
                                <option value="Routier">Routier</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="dateFanekena">Daty Fanekena</label>
                            <input type="date" id="dateFanekena" name="dateFanekena">
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-secondary" onclick="closeAddModal()">
                        <i class="fas fa-times"></i> Hanafoana
                    </button>
                    <button type="submit" class="btn-primary">
                        <i class="fas fa-save"></i> Tehirizina
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Modifier Élève -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-user-edit"></i> Hanova Beazina</h2>
                <button class="modal-close" onclick="closeEditModal()">&times;</button>
            </div>
            <form th:action="@{/eleves/modifier}" method="post">
                <input type="hidden" id="editId" name="id">
                <div class="modal-body">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="editNom">Anarana <span class="required">*</span></label>
                            <input type="text" id="editNom" name="nom" required>
                        </div>
                        <div class="form-group">
                            <label for="editPrenom">Fanampin'anarana <span class="required">*</span></label>
                            <input type="text" id="editPrenom" name="prenom" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="editTotem">Totem</label>
                            <input type="text" id="editTotem" name="totem">
                        </div>
                        <div class="form-group">
                            <label for="editDateNaissance">Daty nahaterahana</label>
                            <input type="date" id="editDateNaissance" name="dateNaissance">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="editNomPere">Anaran'ny Ray</label>
                            <input type="text" id="editNomPere" name="nomPere">
                        </div>
                        <div class="form-group">
                            <label for="editNomMere">Anaran'ny Reny</label>
                            <input type="text" id="editNomMere" name="nomMere">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="editSecteurId">Sektora</label>
                            <select id="editSecteurId" name="secteurId">
                                <option value="">-- Mifidy --</option>
                                <option th:each="secteur : ${secteurs}" th:value="${secteur.id}" th:text="${secteur.nom}"></option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="editFizaranaId">Fizarana</label>
                            <select id="editFizaranaId" name="fizaranaId">
                                <option value="">-- Mifidy --</option>
                                <option th:each="fizarana : ${fizarana}" th:value="${fizarana.id}" th:text="${fizarana.nom}"></option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="editAmbaratonga">Ambaratonga</label>
                            <select id="editAmbaratonga" name="ambaratonga">
                                <option value="">-- Mifidy --</option>
                                <option value="Louveteau">Louveteau</option>
                                <option value="Éclaireur">Éclaireur</option>
                                <option value="Routier">Routier</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="editDateFanekena">Daty Fanekena</label>
                            <input type="date" id="editDateFanekena" name="dateFanekena">
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-secondary" onclick="closeEditModal()">
                        <i class="fas fa-times"></i> Hanafoana
                    </button>
                    <button type="submit" class="btn-primary">
                        <i class="fas fa-save"></i> Tehirizina
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Toggle sidebar mobile
        function toggleSidebar() {
            const sidebar = document.querySelector('.sidebar');
            sidebar.classList.toggle('active');
        }

        // Toggle sidebar collapse/expand
        function toggleSidebarCollapse() {
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.querySelector('.main-content');
            const toggleIcon = sidebar.querySelector('.sidebar-toggle i');
            
            sidebar.classList.toggle('collapsed');
            mainContent.classList.toggle('sidebar-collapsed');
            
            if (sidebar.classList.contains('collapsed')) {
                toggleIcon.classList.remove('fa-chevron-left');
                toggleIcon.classList.add('fa-chevron-right');
                localStorage.setItem('sidebarCollapsed', 'true');
            } else {
                toggleIcon.classList.remove('fa-chevron-right');
                toggleIcon.classList.add('fa-chevron-left');
                localStorage.setItem('sidebarCollapsed', 'false');
            }
        }
        
        // Restore sidebar state
        document.addEventListener('DOMContentLoaded', function() {
            const isCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';
            if (isCollapsed) {
                const sidebar = document.getElementById('sidebar');
                const mainContent = document.querySelector('.main-content');
                const toggleIcon = sidebar.querySelector('.sidebar-toggle i');
                
                sidebar.classList.add('collapsed');
                mainContent.classList.add('sidebar-collapsed');
                toggleIcon.classList.remove('fa-chevron-left');
                toggleIcon.classList.add('fa-chevron-right');
            }
            
            // Auto-hide alerts after 5 seconds
            setTimeout(() => {
                document.querySelectorAll('.alert').forEach(alert => {
                    alert.style.opacity = '0';
                    setTimeout(() => alert.remove(), 300);
                });
            }, 5000);

            // Attach edit button listeners
            document.querySelectorAll('.edit-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const row = this.closest('tr');
                    openEditModal(row);
                });
            });
        });

        // Tri du tableau
        let sortDirection = {};
        
        function sortTable(columnIndex) {
            const table = document.getElementById('elevesTable');
            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.querySelectorAll('tr:not(.empty-message)'));
            
            sortDirection[columnIndex] = !sortDirection[columnIndex];
            const direction = sortDirection[columnIndex] ? 1 : -1;
            
            rows.sort((a, b) => {
                const aValue = a.cells[columnIndex].textContent.trim();
                const bValue = b.cells[columnIndex].textContent.trim();
                
                if (aValue.match(/^\d{2}\/\d{2}\/\d{4}$/)) {
                    const aDate = aValue.split('/').reverse().join('-');
                    const bDate = bValue.split('/').reverse().join('-');
                    return direction * (new Date(aDate) - new Date(bDate));
                }
                
                return direction * aValue.localeCompare(bValue, 'fr');
            });
            
            document.querySelectorAll('.sortable i').forEach(icon => {
                icon.className = 'fas fa-sort';
            });
            const header = table.querySelectorAll('th')[columnIndex];
            const icon = header.querySelector('i');
            if (icon) {
                icon.className = sortDirection[columnIndex] ? 'fas fa-sort-up' : 'fas fa-sort-down';
            }
            
            rows.forEach(row => tbody.appendChild(row));
        }

        // Appliquer tous les filtres
        function applyFilters() {
            const searchValue = document.getElementById('searchInput').value.toLowerCase();
            const secteurValue = document.getElementById('filterSecteur').value;
            const fizaranaValue = document.getElementById('filterFizarana').value;
            const ambaratongaValue = document.getElementById('filterAmbaratonga').value;
            const assuranceValue = document.getElementById('filterAssurance').value;
            
            const table = document.getElementById('elevesTable');
            const rows = table.querySelectorAll('tbody tr:not(.empty-message)');
            let visibleCount = 0;
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                const secteur = row.getAttribute('data-secteur') || '';
                const fizarana = row.getAttribute('data-fizarana') || '';
                const ambaratonga = row.getAttribute('data-ambaratonga') || '';
                const assurance = row.getAttribute('data-assurance') || '';
                
                const matchSearch = !searchValue || text.includes(searchValue);
                const matchSecteur = !secteurValue || secteur === secteurValue;
                const matchFizarana = !fizaranaValue || fizarana === fizaranaValue;
                const matchAmbaratonga = !ambaratongaValue || ambaratonga === ambaratongaValue;
                const matchAssurance = !assuranceValue || assurance === assuranceValue;
                
                if (matchSearch && matchSecteur && matchFizarana && matchAmbaratonga && matchAssurance) {
                    row.style.display = '';
                    visibleCount++;
                } else {
                    row.style.display = 'none';
                }
            });
            
            document.getElementById('recordCount').textContent = visibleCount + ' Beazina';
            document.getElementById('paginationInfo').textContent = '1-' + visibleCount + ' sur ' + visibleCount;
        }

        // Réinitialiser les filtres
        function resetFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('filterSecteur').value = '';
            document.getElementById('filterFizarana').value = '';
            document.getElementById('filterAmbaratonga').value = '';
            document.getElementById('filterAssurance').value = '';
            applyFilters();
        }

        // Modal Ajouter functions
        function openAddModal() {
            document.getElementById('addModal').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeAddModal() {
            document.getElementById('addModal').classList.remove('active');
            document.body.style.overflow = '';
        }

        // Modal Modifier functions
        function openEditModal(row) {
            document.getElementById('editId').value = row.dataset.id;
            document.getElementById('editNom').value = row.dataset.nom || '';
            document.getElementById('editPrenom').value = row.dataset.prenom || '';
            document.getElementById('editTotem').value = row.dataset.totem || '';
            document.getElementById('editDateNaissance').value = row.dataset.datenaissance || '';
            document.getElementById('editNomPere').value = row.dataset.nompere || '';
            document.getElementById('editNomMere').value = row.dataset.nommere || '';
            document.getElementById('editDateFanekena').value = row.dataset.datefanekena || '';
            document.getElementById('editSecteurId').value = row.dataset.secteurid || '';
            document.getElementById('editFizaranaId').value = row.dataset.fizaranaid || '';
            document.getElementById('editAmbaratonga').value = row.dataset.ambaratonga || '';
            
            document.getElementById('editModal').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.remove('active');
            document.body.style.overflow = '';
        }

        // Close modals on outside click
        document.getElementById('addModal').addEventListener('click', function(e) {
            if (e.target === this) closeAddModal();
        });
        document.getElementById('editModal').addEventListener('click', function(e) {
            if (e.target === this) closeEditModal();
        });

        // Close modals on Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeAddModal();
                closeEditModal();
            }
        });

        // Fonction helper pour convertir une image en base64
        function imageToBase64(url, callback) {
            fetch(url)
                .then(response => response.blob())
                .then(blob => {
                    const reader = new FileReader();
                    reader.onloadend = function() {
                        callback(reader.result);
                    };
                    reader.onerror = function() {
                        callback(null);
                    };
                    reader.readAsDataURL(blob);
                })
                .catch(error => {
                    console.error('Hadisoana rehefa mampiditra ny sary:', error);
                    callback(null);
                });
        }

        // Export PDF
        function exportToPDF() {
            const table = document.getElementById('elevesTable');
            const rows = table.querySelectorAll('tbody tr:not(.empty-message)');
            const visibleRows = Array.from(rows).filter(row => row.style.display !== 'none');
            
            if (visibleRows.length === 0) {
                alert('Tsy misy angona hivoaka');
                return;
            }

            const secteur = document.getElementById('filterSecteur').value;
            const fizarana = document.getElementById('filterFizarana').value;
            const ambaratonga = document.getElementById('filterAmbaratonga').value;
            const assurance = document.getElementById('filterAssurance').value;
            
            let filterTitle = 'Lisitry ny Beazina';
            let filters = [];
            if (secteur) filters.push('Sektora: ' + secteur);
            if (fizarana) filters.push('Fizarana: ' + fizarana);
            if (ambaratonga) filters.push('Ambaratonga: ' + ambaratonga);
            if (assurance) filters.push('Fiantohana: ' + assurance);
            
            // Charger l'image et la convertir en base64
            const imageUrl = window.location.origin + '/images/top-tily.jpg';
            imageToBase64(imageUrl, function(imageBase64) {
                let printContent = `
                    <html>
                    <head>
                        <title>Alaina Beazina - Tily</title>
                        <style>
                            body { font-family: Arial, sans-serif; padding: 20px; }
                            .header-image { width: 100%; max-width: 800px; margin: 0 auto 20px; display: block; }
                            h1 { color: #0B1739; font-size: 24px; margin-bottom: 5px; }
                            .filters { color: #666; font-size: 12px; margin-bottom: 20px; }
                            .date { color: #666; font-size: 11px; margin-bottom: 20px; }
                            table { width: 100%; border-collapse: collapse; font-size: 11px; }
                            th { background: #0B1739; color: white; padding: 10px 8px; text-align: left; }
                            td { padding: 8px; border-bottom: 1px solid #ddd; }
                            tr:nth-child(even) { background: #f9f9f9; }
                            .footer { margin-top: 30px; text-align: center; color: #666; font-size: 10px; }
                        </style>
                    </head>
                    <body>
                        ${imageBase64 ? '<img src="' + imageBase64 + '" alt="Tily" class="header-image">' : ''}
                        <h1>${filterTitle}</h1>
                        ${filters.length > 0 ? '<p class="filters">Sivana: ' + filters.join(' | ') + '</p>' : ''}
                        <p class="date">Voaloa tamin'ny: ${new Date().toLocaleDateString('fr-FR')} amin'ny ${new Date().toLocaleTimeString('fr-FR')}</p>
                    <table>
                        <thead>
                            <tr>
                                <th>Anarana</th>
                                <th>Fanampin'anarana</th>
                                <th>Totem</th>
                                <th>Daty nahaterahana</th>
                                <th>Anaran'ny Ray</th>
                                <th>Anaran'ny Reny</th>
                                <th>Sektora</th>
                                <th>Fizarana</th>
                                <th>Ambaratonga</th>
                                <th>Fiantohana</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            visibleRows.forEach(row => {
                const cells = row.querySelectorAll('td');
                printContent += `
                    <tr>
                        <td>${cells[1].textContent}</td>
                        <td>${cells[2].textContent}</td>
                        <td>${cells[3].textContent}</td>
                        <td>${cells[4].textContent}</td>
                        <td>${cells[5].textContent}</td>
                        <td>${cells[6].textContent}</td>
                        <td>${cells[7].textContent}</td>
                        <td>${cells[8].textContent}</td>
                        <td>${cells[9].textContent}</td>
                        <td>${cells[11].textContent}</td>
                    </tr>
                `;
            });
            
                printContent += `
                            </tbody>
                        </table>
                        <div class="footer">
                            <p>Total: ${visibleRows.length} Beazina - Tily © ${new Date().getFullYear()}</p>
                        </div>
                    </body>
                    </html>
                `;
                
                const printWindow = window.open('', '_blank');
                printWindow.document.write(printContent);
                printWindow.document.close();
                printWindow.focus();
                setTimeout(() => printWindow.print(), 250);
            });
        }
    </script>
</body>
</html>
